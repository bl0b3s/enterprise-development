# Лабораторная работа 4: Генератор контрактов и обмен сообщениями через Apache Kafka


## Вариант 80

* **Platform**: .NET 8 (C# 12)
* **Database**: SqlServer
* **ORM**: Entity Framework Core 8
* **Messaging**: Apache Kafka
* **Mapping**: AutoMapper
* **Testing**: xUnit, Bogus (Fake Data)
* **Orchestration**: .NET Aspire


## Описание предметной области

Реализована объектная модель для пункта проката автомобилей со следующими сущностями:

- **`CarModel`** – модель автомобиля (справочник): тип привода, класс, тип кузова, количество мест.
- **`ModelGeneration`** – поколение модели: год выпуска, объём двигателя, коробка передач, стоимость часа аренды.
- **`Car`** – физический экземпляр автомобиля: госномер, цвет, поколение модели.
- **`Client`** – клиент: номер водительского удостоверения, ФИО, дата рождения.
- **`Rental`** – договор аренды: клиент, автомобиль, время выдачи, длительность в часах.

## Реализованные компоненты

### CarRental.Generator.Kafka.Host

Сервис-генератор контрактов аренды с REST API:

- **`RentalGenerator`** — генерирует тестовые DTO записей об аренде с использованием библиотеки Bogus.
- **`RentalKafkaProducer`** — отправляет пачки контрактов в Kafka топик `rentals`.
- **`GeneratorController`** — REST-контроллер для запуска генерации через HTTP-запрос:
  - `POST /api/Generator/rentals?listSize=100&batchSize=10&delayMs=500`

### CarRental.Infrastructure.Kafka

Инфраструктурный слой для работы с Kafka:

- **`RentalKafkaConsumer`** — фоновый сервис (`BackgroundService`), который:
  - Подписывается на топик `rentals`
  - Обрабатывает входящие сообщения с контрактами
  - Валидирует связи с существующими `Car` и `Client`
  - Сохраняет валидные записи об аренде в базу данных


## Конфигурация Aspire (AppHost)

В оркестратор добавлены:
- **SQL Server** с базой данных `CarRentalDb`
- **Apache Kafka** с UI для мониторинга
- **CarRental.API** — основной сервер с Consumer
- **CarRental.Generator.Kafka.Host** — сервис генерации контрактов


## Результат 4 лабораторной работы

- Реализован сервис-генератор контрактов (`CarRental.Generator.Kafka.Host`), который создаёт тестовые записи об аренде и отправляет их в Kafka.
- Реализован Kafka Consumer (`RentalKafkaConsumer`), который получает контракты из топика и сохраняет их в базу данных с валидацией связей.
- В конфигурацию Aspire добавлен запуск брокера сообщений Apache Kafka и сервиса-генератора.
- Все компоненты запускаются через единый оркестратор с автоматическим управлением зависимостями.
